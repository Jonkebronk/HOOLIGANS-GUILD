generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum WowClass {
  Druid
  Hunter
  Mage
  Paladin
  Priest
  Rogue
  Shaman
  Warlock
  Warrior
}

enum Role {
  Tank
  Heal
  DPS
}

enum RoleSubtype {
  Tank
  Heal
  DPS_Melee
  DPS_Ranged
  DPS_Caster
}

enum LootResponse {
  BiS
  GreaterUpgrade
  MinorUpgrade
  Offspec
  PvP
  Disenchant
}

enum Phase {
  P1
  P2
  P3
  P4
  P5
}

enum GearSlot {
  Head
  Neck
  Shoulder
  Back
  Chest
  Wrist
  Hands
  Waist
  Legs
  Feet
  Finger
  Finger1
  Finger2
  Trinket
  Trinket1
  Trinket2
  MainHand
  OneHand
  TwoHand
  OffHand
  Shield
  HeldInOffhand
  Ranged
  Relic
  Wand
  Thrown
  Misc
}

enum UserRole {
  GM
  Officer
  Raider
}

enum TeamRole {
  Owner
  Admin
  Member
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

// ============================================
// AUTH & USERS (NextAuth.js compatible)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // Discord fields
  discordId     String?   @unique
  discordName   String?

  // Battle.net fields
  battleNetId   String?   @unique
  battleNetTag  String?

  // App-specific
  role          UserRole  @default(Raider)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // App relations
  players       Player[]  // A user can have multiple characters
  teamMembers   TeamMember[] // Teams this user belongs to
  reviewedApplications Application[] @relation("ReviewedApplications")
}

// ============================================
// TEAMS
// ============================================

model Team {
  id            String    @id @default(cuid())
  name          String    // e.g., "TEAM NATO", "TEAM SWEDEN", "PuG"
  description   String?
  icon          String?   // URL to team icon/logo
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  members       TeamMember[]
  players       Player[]
  raidSplits    RaidSplit[]
  lootRecords   LootRecord[]
  attendance    AttendanceRecord[]
  rosterAssignments RosterAssignment[]
  raidPerformances RaidPerformance[]
  applications  Application[]

  @@index([name])
}

model TeamMember {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role          TeamRole  @default(Member)
  joinedAt      DateTime  @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// ROSTER
// ============================================

model Player {
  id            String    @id @default(cuid())
  name          String
  class         WowClass
  mainSpec      String    // e.g., "DruidBalance", "WarriorFury"
  offSpec       String?
  role          Role
  roleSubtype   RoleSubtype
  notes         String?   // e.g., "BiS wep P1-2", "pass on crafting"
  active        Boolean   @default(true)
  discordId     String?   // Discord user ID for @mentions
  raidTeam      Int?      // 1, 2, or 3 for 10-man splits
  joinedDate    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  lootRecords   LootRecord[]
  attendance    AttendanceRecord[]
  bisStatus     PlayerBisStatus[]
  raidQuests    RaidQuest[]
  raidSplits    RaidSplitMember[]
  currentGear   PlayerGear[]
  rosterAssignments RosterAssignment[]
  feedbackChannels FeedbackChannel[]

  @@unique([name, teamId]) // Player names unique per team
  @@index([class])
  @@index([active])
  @@index([teamId])
}

model PlayerGear {
  id            String    @id @default(cuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  slot          GearSlot
  itemId        String?
  item          Item?     @relation(fields: [itemId], references: [id])
  wowheadId     Int?      // For items not in our DB
  itemName      String?   // For items not in our DB
  icon          String?   // Icon name for display
  enchantId     Int?
  gem1Id        Int?
  gem2Id        Int?
  gem3Id        Int?
  updatedAt     DateTime  @updatedAt

  @@unique([playerId, slot])
  @@index([playerId])
}

// ============================================
// ITEMS & LOOT
// ============================================

model Item {
  id            String    @id @default(cuid())
  name          String
  wowheadId     Int?      // For tooltips/icons
  icon          String?   // Icon name for ZamImg CDN
  quality       Int       @default(4) // 0=Poor, 1=Common, 2=Uncommon, 3=Rare, 4=Epic, 5=Legendary
  slot          GearSlot
  raid          String    // e.g., "Karazhan", "Black Temple"
  boss          String
  phase         Phase
  lootPriority  String?   // Special priority notes (e.g., "Tanks > Melee DPS")
  bisFor        String?   // Who is this BiS for (e.g., "Rogues, Fury Warriors")
  bisNextPhase  String?   // Who will need this next phase
  lootPoints    Int       @default(100)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt @default(now())

  // Relations
  lootRecords   LootRecord[]
  bisSpecs      ItemBisSpec[]
  playerGear    PlayerGear[]

  @@unique([name, raid])
  @@index([raid])
  @@index([slot])
  @@index([phase])
}

model ItemBisSpec {
  id              String    @id @default(cuid())
  itemId          String
  item            Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  spec            String    // e.g., "DruidBalance"
  isCurrentPhase  Boolean   @default(true)
  isNextPhase     Boolean   @default(false)

  @@unique([itemId, spec])
  @@index([spec])
}

model LootRecord {
  id            String        @id @default(cuid())
  itemId        String?
  item          Item?         @relation(fields: [itemId], references: [id])
  playerId      String?
  player        Player?       @relation(fields: [playerId], references: [id])
  teamId        String?
  team          Team?         @relation(fields: [teamId], references: [id])
  response      LootResponse?
  lootDate      DateTime      @default(now())
  phase         Phase         @default(P1)
  lootPoints    Int           @default(0)

  // For items not in Item table (from RC import)
  itemName      String?
  wowheadId     Int?
  quality       Int?          @default(4)
  lootPrio      String?

  // RCLootCouncil import fields
  rcTimestamp   DateTime?
  rcSessionId   String?

  createdAt     DateTime      @default(now())

  @@index([playerId])
  @@index([itemId])
  @@index([lootDate])
  @@index([rcSessionId])
  @@index([teamId])
}

// ============================================
// BIS CONFIGURATION
// ============================================

model BisConfiguration {
  id            String    @id @default(cuid())
  spec          String    // e.g., "DruidBalance"
  phase         Phase
  slot          GearSlot
  itemName      String
  source        String?   // Boss/location
  wowheadId     Int?
  icon          String?   // Icon name for display
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([spec, phase, slot])
  @@index([spec])
  @@index([phase])
}

model PlayerBisStatus {
  id            String    @id @default(cuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  slot          GearSlot
  phase         Phase
  obtained      Boolean   @default(false)
  obtainedDate  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([playerId, slot, phase])
  @@index([playerId])
}

// ============================================
// ATTENDANCE
// ============================================

model AttendanceRecord {
  id              String    @id @default(cuid())
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  teamId          String?
  team            Team?     @relation(fields: [teamId], references: [id])
  raidDate        DateTime
  raidName        String    // e.g., "Karazhan", "Black Temple"
  attended        Boolean   @default(false)
  fullyAttended   Boolean   @default(false) // Present for entire raid
  createdAt       DateTime  @default(now())

  @@unique([playerId, raidDate, raidName])
  @@index([playerId])
  @@index([raidDate])
  @@index([teamId])
}

// ============================================
// RAID MANAGEMENT
// ============================================

model RaidSplit {
  id            String    @id @default(cuid())
  name          String    // e.g., "Karazhan Team 1"
  raidNumber    Int       // 1, 2, or 3
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  members       RaidSplitMember[]

  @@unique([raidNumber, teamId]) // Raid numbers unique per team
  @@index([teamId])
}

model RaidSplitMember {
  id            String    @id @default(cuid())
  splitId       String
  split         RaidSplit @relation(fields: [splitId], references: [id], onDelete: Cascade)
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id])
  role          Role

  @@unique([splitId, playerId])
  @@index([splitId])
}

model RaidQuest {
  id            String    @id @default(cuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  questName     String    // e.g., "Magtheridon's Head", "Verdant Sphere"
  phase         Phase
  completed     Boolean   @default(false)
  completedDate DateTime?
  createdAt     DateTime  @default(now())

  @@unique([playerId, questName])
}

model RosterAssignment {
  id            String    @id @default(cuid())
  raidId        String    // "25man" or "10man-1", "10man-2", "10man-3"
  groupIndex    Int       // 0-4 for 25-man, 0-1 for 10-man
  slotIndex     Int       // 0-4
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([teamId, raidId, groupIndex, slotIndex]) // One player per slot per team
  @@index([playerId])
  @@index([raidId])
  @@index([teamId])
}

// ============================================
// CONFIGURATION
// ============================================

model ClassConfig {
  id            String    @id @default(cuid())
  className     WowClass  @unique
  colorHex      String    // e.g., "#FF7C0A" for Druid
  tokenType     String?   // "Fallen Defender", "Fallen Hero", "Fallen Champion"
}

model TierSetConfig {
  id            String    @id @default(cuid())
  tier          String    // "T4", "T5", "T6"
  className     WowClass
  chestName     String?
  handsName     String?
  headName      String?
  legsName      String?
  shouldersName String?

  @@unique([tier, className])
}

// ============================================
// PERFORMANCE TRACKING
// ============================================

model RaidPerformance {
  id              String    @id @default(cuid())
  teamId          String
  team            Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  raidDate        DateTime
  raidNames       String    @default("[]") // JSON array of raid names, e.g., ["Karazhan", "Gruul's Lair"]
  wclUrl          String?   // Warcraft Logs URL
  rpbUrl          String?   // RPB analysis sheet URL
  claUrl          String?   // CLA analysis sheet URL
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  feedbackChannels FeedbackChannel[]

  @@index([teamId])
  @@index([raidDate])
}

model FeedbackChannel {
  id                  String           @id @default(cuid())
  playerId            String
  player              Player           @relation(fields: [playerId], references: [id], onDelete: Cascade)
  raidPerformanceId   String?
  raidPerformance     RaidPerformance? @relation(fields: [raidPerformanceId], references: [id], onDelete: SetNull)
  discordChannelId    String           @unique
  channelName         String           // e.g., "feedback-playername"
  isArchived          Boolean          @default(false)
  createdAt           DateTime         @default(now())
  archivedAt          DateTime?

  @@index([playerId])
  @@index([discordChannelId])
  @@index([raidPerformanceId])
}

// ============================================
// RECRUITMENT & APPLICATIONS
// ============================================

model Application {
  id              String            @id @default(cuid())
  teamId          String
  team            Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Applicant Info (from Discord auth)
  discordId       String
  discordName     String
  inGameName      String

  // Character Info
  characterName   String
  realm           String?
  class           WowClass
  mainSpec        String
  offSpec         String?

  // Application Data
  professions     String?           // e.g., "Enchanting 375, Jewelcrafting 350"
  warcraftLogsUrl String?
  raidExperience  String?           @db.Text
  availability    Boolean           @default(false) // Can maintain 90%+ attendance
  uiScreenshot    String?           // Cloudinary URL
  gearScreenshot  String?           // Cloudinary URL
  additionalInfo  String?           @db.Text

  // Review
  status          ApplicationStatus @default(PENDING)
  officerNotes    String?           @db.Text
  reviewedById    String?
  reviewedBy      User?             @relation("ReviewedApplications", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?

  // Cached WCL Data
  wclBestPerf     Float?            // Best performance average
  wclMedianPerf   Float?            // Median performance
  wclParseCount   Int?              // Number of logged kills

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([teamId])
  @@index([status])
  @@index([class])
  @@index([discordId])
}
